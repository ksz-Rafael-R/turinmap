<!DOCTYPE html>
<html>
<head>
  <title>Interaktive Karte Turin</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cuprum:ital,wght@0,400..700;1,400..700&family=Lexend+Giga:wght@100..900&family=Saira+Semi+Condensed:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">


  <style>
    body {
      margin: 0;
      font-family: "Cuprum", sans-serif;
      font-optical-sizing: auto;
      font-weight: 20px;
      font-style: normal;
    }
    header {
      background: #00b300;
      background: linear-gradient(90deg, rgba(0, 179, 0, 1) 0%, rgba(255, 255, 255, 1) 35%, rgba(255, 255, 255, 1) 65%, rgba(255, 0, 0, 1) 100%);
      width: 100%;
      height: 70px;
      padding-left: 10px;
      display: flex;
      align-items: center;
    }
    #titel {
      margin: 0;
    }

    #map {
      height: 600px;
      width: 100%;
    }
    .popup-imgs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 5px;
    }
    .popup-imgs img {
      width: 100px;
      border-radius: 4px;
    }
    .popup-buttons {
      margin-top: 6px;
    }
    .popup-buttons button {
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <header>
    
    <h2 id="title">Interaktive Karte Turin</h2>
  </header>
  <div class="controls" id="controls"></div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([45.066667, 7.7], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    const tagStatus = {}; // Speichert den Aktivierungsstatus jeder Tag-Checkbox
    const tagToEntries = {}; // tag -> Liste der Einträge
    const allEntries = []; // Alle Marker-Objekte mit ihren Tags

    function generatePopupContent(entry) {
      let html = "";
      if (entry.title) html += `<b>${entry.title}</b><br>`;
      if (entry.text) html += `${entry.text}<br>`;
      if (entry.images && entry.images.length) {
        html += `<div class="popup-imgs">`;
        entry.images.forEach(url => {
          html += `<img src="${url}">`;
        });
        html += `</div>`;
      }
      if (entry.buttons && entry.buttons.length) {
        html += `<div class="popup-buttons">`;
        entry.buttons.forEach(btn => {
          html += `<button onclick="${btn.action}">${btn.label}</button>`;
        });
        html += `</div>`;
      }
      return html;
    }

    function toggleLayer(tag) {
      tagStatus[tag] = !tagStatus[tag];
      updateMapVisibility();
    }

    function updateMapVisibility() {
      allEntries.forEach(obj => {
        // Wenn mindestens einer seiner Tags aktiv ist, soll er sichtbar sein
        const isVisible = obj.tags.some(tag => tagStatus[tag]);
        if (isVisible) {
          if (!map.hasLayer(obj.layer)) {
            obj.layer.addTo(map);
          }
        } else {
          if (map.hasLayer(obj.layer)) {
            map.removeLayer(obj.layer);
          }
        }
      });
    }

    fetch('data.json')
      .then(res => res.json())
      .then(entries => {
        const controlsDiv = document.getElementById('controls');
        const seenTags = new Set();

        entries.forEach(entry => {
          const popup = generatePopupContent(entry);
          let layer;

          // Ein einziges Layer-Objekt erstellen
          switch (entry.type) {
            case "marker":
              layer = L.marker(entry.coords).bindPopup(popup);
              break;
            case "circle":
              layer = L.circle(entry.coords, {
                color: entry.color || 'red',
                fillColor: entry.fill_color || '#f03',
                fillOpacity: entry.transparency || 0.5,
                radius: entry.radius || 200
              }).bindPopup(popup);
              break;
            case "routes":
              layer = L.polyline(entry.coords, {
                color: entry.color || 'blue'
              }).bindPopup(popup);
              break;
            case "polygon":
              layer = L.polygon(entry.coords, {
                color: entry.color || "blue",
                fillColor: entry.fill_color || '#f03',
                fillOpacity: entry.transparency || 0.5,
              }).bindPopup(popup);
              break
            default:
              console.warn("Unbekannter Typ:", entry.type);
              return;
          }

          // Speichern mit Tags
          const tags = entry.tag || [];
          allEntries.push({ layer, tags });

          // Neue Tags sammeln
          tags.forEach(tag => {
            if (!seenTags.has(tag)) {
              seenTags.add(tag);
              tagStatus[tag] = true; // initial sichtbar

              const label = document.createElement('label');
              label.innerHTML = `<input type="checkbox" checked onchange="toggleLayer('${tag}')"> ${tag}`;
              controlsDiv.appendChild(label);
            }
          });
        });

        updateMapVisibility(); // Startanzeige
      });
  </script>
</body>
</html>

